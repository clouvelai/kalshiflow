[build]
builder = "nixpacks"
# Force Python detection by specifying nixpacks.toml inline
nixpacksPlan = """
[variables]
NIXPACKS_PROVIDERS = "python"

[phases.setup]
nixPkgs = ['python311', 'python311Packages.pip']

[phases.install] 
cmds = ['python -m pip install uv', 'uv sync']

[phases.build]
cmds = []

[start]
cmd = 'uv run uvicorn kalshiflow.app:app --host 0.0.0.0 --port $PORT'
"""

[deploy]
# Use the Procfile command which Railway will detect
startCommand = "uv run uvicorn kalshiflow.app:app --host 0.0.0.0 --port $PORT"
# Health check endpoint
healthcheckPath = "/health"
healthcheckTimeout = 300
restartPolicyType = "on_failure"
# Graceful shutdown timeout for WebSocket connections
restartPolicyMaxRetries = 3

[environments]
[environments.production]
RAILWAY_ENVIRONMENT_NAME = "production"
# Enable production optimizations
PYTHONUNBUFFERED = "1"
PYTHONDONTWRITEBYTECODE = "1"