{
  "project": "Kalshi Flowboard",
  "deployment_strategy": "Render + Supabase",
  "created_at": "2025-12-05",
  "last_updated": "2025-12-05T16:00:00Z",
  "overview": {
    "hosting_platform": "Render",
    "database": "Supabase PostgreSQL",
    "architecture": "Full-stack deployment with native WebSocket support",
    "estimated_cost": "$30-50/month",
    "deployment_time": "4-6 hours total setup"
  },
  "why_render": {
    "websocket_support": "Native WebSocket support (critical requirement)",
    "python_starlette_support": "Full Python/Starlette/ASGI support",
    "unified_platform": "Backend and frontend on same platform",
    "git_deployment": "Simple Git-based deployment workflow",
    "managed_services": "Built-in SSL, domains, and auto-scaling"
  },
  "why_supabase": {
    "postgresql_performance": "Superior concurrent connection handling vs SQLite",
    "cloud_native": "Perfect match for Render deployment",
    "connection_pooling": "Built-in pooling for production workloads",
    "backup_scaling": "Managed backups and horizontal scaling",
    "development_friendly": "Local development support + free tier"
  },
  "required_tools": {
    "supabase_cli": {
      "installation": "npm install -g supabase",
      "purpose": "Database management, migrations, local development",
      "key_commands": [
        "supabase login",
        "supabase init",
        "supabase start (local development)",
        "supabase db push (schema changes)",
        "supabase db dump (backup)"
      ]
    },
    "render_cli": {
      "installation": "pip install render",
      "purpose": "Deployment automation and service management",
      "alternative": "Use Render dashboard for initial setup"
    },
    "postgresql_tools": {
      "asyncpg": "pip install asyncpg (Python PostgreSQL driver)",
      "psycopg2": "pip install psycopg2-binary (backup driver)",
      "pgcli": "pip install pgcli (PostgreSQL CLI tool)",
      "purpose": "Database connectivity and management"
    },
    "development_tools": {
      "docker": "For local PostgreSQL if needed",
      "git": "Version control and deployment trigger",
      "environment_management": "python-dotenv for .env files"
    }
  },
  "phases": {
    "phase_1": {
      "name": "Database Migration to Supabase PostgreSQL",
      "duration": "4-6 hours",
      "priority": 1,
      "milestones": [
        {
          "id": "1.1",
          "name": "Supabase Project Setup",
          "duration": "30 minutes",
          "tasks": [
            "Create new Supabase project at https://supabase.com",
            "Configure database settings (region: us-east-1 recommended)",
            "Enable Row Level Security (RLS)",
            "Obtain connection strings (Database > Settings > Database)",
            "Note down: Project URL, API Keys, Database Password"
          ],
          "deliverables": [
            "Supabase project created",
            "Connection strings documented",
            "Database credentials secured"
          ]
        },
        {
          "id": "1.2", 
          "name": "Local Environment Configuration",
          "duration": "30 minutes",
          "tasks": [
            "Install Supabase CLI: npm install -g supabase",
            "Install PostgreSQL tools: pip install asyncpg psycopg2-binary",
            "Update .env with Supabase connection details",
            "Create .env.example with Supabase template",
            "Test connection with Supabase CLI: supabase login"
          ],
          "environment_variables": {
            "DATABASE_URL": "postgresql://postgres:[PASSWORD]@db.[PROJECT_ID].supabase.co:5432/postgres",
            "DATABASE_URL_POOLED": "postgresql://postgres:[PASSWORD]@db.[PROJECT_ID].supabase.co:6543/postgres",
            "SUPABASE_URL": "https://[PROJECT_ID].supabase.co",
            "SUPABASE_ANON_KEY": "[ANON_KEY]",
            "SUPABASE_SERVICE_ROLE_KEY": "[SERVICE_ROLE_KEY]"
          }
        },
        {
          "id": "1.3",
          "name": "Database Schema Migration",
          "duration": "2 hours",
          "tasks": [
            "Create migration SQL files for PostgreSQL",
            "Convert SQLite schema to PostgreSQL (trades and markets tables)",
            "Add PostgreSQL-specific indexes and constraints",
            "Create database migration script",
            "Test schema creation in Supabase"
          ],
          "files_to_modify": [
            "backend/src/kalshiflow/database.py",
            "backend/migrations/001_initial_schema.sql",
            "backend/migrations/002_indexes.sql"
          ],
          "schema_changes": {
            "trades_table": "Convert to PostgreSQL with proper data types",
            "markets_table": "Add PostgreSQL-specific optimizations",
            "indexes": "Optimize for PostgreSQL query planner",
            "constraints": "Add foreign keys and check constraints"
          }
        },
        {
          "id": "1.4",
          "name": "Backend Database Layer Refactor",
          "duration": "3 hours",
          "tasks": [
            "Replace aiosqlite with asyncpg in database.py",
            "Update all SQL queries for PostgreSQL compatibility",
            "Implement PostgreSQL connection pooling",
            "Update database initialization and migration logic",
            "Test all database operations"
          ],
          "files_to_modify": [
            "backend/src/kalshiflow/database.py",
            "backend/src/kalshiflow/app.py",
            "backend/pyproject.toml"
          ],
          "technical_changes": {
            "driver_replacement": "aiosqlite → asyncpg",
            "connection_management": "SQLite file → PostgreSQL connection pool",
            "query_syntax": "SQLite-specific → PostgreSQL-compatible",
            "transaction_handling": "Update for PostgreSQL patterns"
          }
        },
        {
          "id": "1.5",
          "name": "Testing and Validation",
          "duration": "1 hour",
          "tasks": [
            "Update all database tests for PostgreSQL",
            "Run backend E2E regression tests",
            "Verify warm restart functionality with PostgreSQL",
            "Test data consistency and performance",
            "Validate all aggregation and analytics services"
          ],
          "success_criteria": [
            "All backend tests pass with PostgreSQL",
            "E2E regression test completes successfully",
            "Performance meets or exceeds SQLite baseline",
            "No data consistency issues"
          ]
        }
      ]
    },
    "phase_2": {
      "name": "Render Deployment Infrastructure",
      "duration": "3-4 hours",
      "priority": 2,
      "prerequisites": ["Phase 1 completed", "PostgreSQL migration tested"],
      "milestones": [
        {
          "id": "2.1",
          "name": "Render Account and Service Setup",
          "duration": "1 hour",
          "tasks": [
            "Create Render account at https://render.com",
            "Connect GitHub repository to Render",
            "Create backend web service configuration",
            "Create frontend static site configuration",
            "Configure build settings for both services"
          ],
          "render_backend_config": {
            "service_type": "Web Service",
            "environment": "Python 3",
            "build_command": "cd backend && uv sync",
            "start_command": "cd backend && uv run uvicorn kalshiflow.app:app --host 0.0.0.0 --port $PORT",
            "root_directory": "./",
            "python_version": "3.11"
          },
          "render_frontend_config": {
            "service_type": "Static Site",
            "build_command": "cd frontend && npm install && npm run build",
            "publish_directory": "frontend/dist",
            "root_directory": "./"
          }
        },
        {
          "id": "2.2",
          "name": "Environment Variables Configuration",
          "duration": "30 minutes",
          "tasks": [
            "Add all environment variables to Render backend service",
            "Configure Kalshi API credentials securely",
            "Set up Supabase connection strings",
            "Configure production-specific settings",
            "Test environment variable access"
          ],
          "render_environment_variables": {
            "DATABASE_URL": "Supabase pooled connection string",
            "KALSHI_API_KEY": "Kalshi API key ID",
            "KALSHI_PRIVATE_KEY_PATH": "Path to private key file",
            "KALSHI_WS_URL": "wss://api.elections.kalshi.com/trade-api/ws/v2",
            "WINDOW_MINUTES": "10",
            "HOT_MARKETS_LIMIT": "20",
            "RECENT_TRADES_LIMIT": "200",
            "WARM_RESTART_ENABLED": "true",
            "METADATA_FETCH_ENABLED": "true"
          }
        },
        {
          "id": "2.3",
          "name": "Build Pipeline Configuration",
          "duration": "1 hour",
          "tasks": [
            "Create render.yaml for infrastructure as code",
            "Configure automatic deployment triggers",
            "Set up health check endpoints",
            "Configure proper timeouts and scaling",
            "Test build and deployment process"
          ],
          "files_to_create": [
            "render.yaml",
            "backend/requirements.txt (generated from pyproject.toml)",
            "scripts/deploy.sh"
          ],
          "render_yaml_structure": {
            "services": [
              {
                "type": "web",
                "name": "kalshiflow-backend",
                "env": "python",
                "buildCommand": "cd backend && uv sync",
                "startCommand": "cd backend && uv run uvicorn kalshiflow.app:app --host 0.0.0.0 --port $PORT",
                "healthCheckPath": "/health"
              },
              {
                "type": "web", 
                "name": "kalshiflow-frontend",
                "env": "static",
                "buildCommand": "cd frontend && npm install && npm run build",
                "staticPublishPath": "frontend/dist"
              }
            ]
          }
        },
        {
          "id": "2.4",
          "name": "Domain and SSL Configuration",
          "duration": "30 minutes",
          "tasks": [
            "Configure custom domain (optional)",
            "Set up SSL certificates (automatic via Render)",
            "Update frontend API endpoints for production URLs",
            "Configure CORS settings for cross-origin requests",
            "Test domain resolution and SSL"
          ],
          "frontend_config_updates": {
            "api_base_url": "Update to Render backend URL",
            "websocket_url": "Update to Render backend WebSocket URL",
            "cors_settings": "Configure for production domains"
          }
        },
        {
          "id": "2.5",
          "name": "Monitoring and Logging Setup",
          "duration": "1 hour",
          "tasks": [
            "Configure Render built-in logging",
            "Set up application performance monitoring",
            "Configure alerts for service failures",
            "Set up database connection monitoring",
            "Test logging and alerting systems"
          ],
          "monitoring_setup": {
            "render_logs": "Access via Render dashboard",
            "health_checks": "/health, /health/ready endpoints", 
            "metrics": "Response time, error rate, uptime",
            "alerts": "Email notifications for failures"
          }
        }
      ]
    },
    "phase_3": {
      "name": "Production Deployment and Validation",
      "duration": "2-3 hours",
      "priority": 3,
      "prerequisites": ["Phase 2 completed", "Render services configured"],
      "milestones": [
        {
          "id": "3.1",
          "name": "Staging Deployment and Testing",
          "duration": "1.5 hours",
          "tasks": [
            "Deploy to Render staging environment",
            "Run comprehensive E2E tests against staging",
            "Validate WebSocket connections work correctly",
            "Test database operations and warm restart",
            "Verify all real-time functionality"
          ],
          "testing_checklist": [
            "Backend E2E regression test passes",
            "Frontend E2E regression test passes",
            "WebSocket connections stable over time",
            "Database performance acceptable",
            "Warm restart functionality works",
            "All environment variables configured correctly"
          ]
        },
        {
          "id": "3.2",
          "name": "Performance and Security Validation",
          "duration": "1 hour",
          "tasks": [
            "Load test WebSocket connections",
            "Validate database connection pooling",
            "Test SSL/TLS configuration",
            "Verify secret management security",
            "Check for security vulnerabilities"
          ],
          "performance_targets": {
            "websocket_latency": "< 100ms",
            "database_query_time": "< 50ms average",
            "backend_response_time": "< 200ms",
            "frontend_load_time": "< 3 seconds"
          }
        },
        {
          "id": "3.3",
          "name": "Production Launch",
          "duration": "30 minutes",
          "tasks": [
            "Deploy to production Render environment",
            "Update DNS configuration (if custom domain)",
            "Monitor initial production traffic",
            "Validate all systems operational",
            "Create production access documentation"
          ],
          "go_live_checklist": [
            "All services green in Render dashboard",
            "Database connections successful", 
            "WebSocket endpoint responding",
            "Frontend loading correctly",
            "Real-time data flowing properly"
          ]
        },
        {
          "id": "3.4",
          "name": "Documentation and Handoff",
          "duration": "30 minutes",
          "tasks": [
            "Update deployment documentation",
            "Create production runbook",
            "Document monitoring and alerting setup",
            "Create troubleshooting guide",
            "Set up backup and recovery procedures"
          ],
          "deliverables": [
            "Updated deployment_plan.json",
            "Production runbook with procedures",
            "Monitoring dashboard setup",
            "Emergency contact information",
            "Backup and recovery documentation"
          ]
        }
      ]
    }
  },
  "production_urls": {
    "backend": "https://kalshiflow-backend.onrender.com",
    "frontend": "https://kalshiflow-frontend.onrender.com",
    "custom_domain": "TBD (optional)",
    "health_check": "https://kalshiflow-backend.onrender.com/health"
  },
  "cost_breakdown": {
    "render_backend": "$7-25/month (depending on usage)",
    "render_frontend": "$0-7/month (static site)",
    "supabase_database": "$0-25/month (free tier to paid)",
    "total_estimated": "$7-57/month",
    "cost_optimization_notes": [
      "Start with free tiers where possible",
      "Monitor usage and scale as needed",
      "Consider reserved pricing for predictable workloads"
    ]
  },
  "deployment_commands": {
    "local_development": {
      "setup": [
        "supabase login",
        "supabase init",
        "supabase start",
        "cd backend && uv sync",
        "cd frontend && npm install"
      ],
      "run": [
        "cd backend && uv run uvicorn kalshiflow.app:app --reload",
        "cd frontend && npm run dev"
      ]
    },
    "database_management": {
      "schema_update": "supabase db push",
      "backup": "supabase db dump --file backup.sql",
      "migration": "supabase migration new migration_name",
      "reset": "supabase db reset"
    },
    "deployment": {
      "automatic": "git push origin main (triggers Render deploy)",
      "manual": "Use Render dashboard deploy button",
      "rollback": "Render dashboard rollback to previous deploy"
    }
  },
  "troubleshooting": {
    "common_issues": {
      "websocket_connection_failed": {
        "symptoms": "Frontend shows 'Disconnected' status",
        "causes": ["Backend service down", "Network issues", "CORS misconfiguration"],
        "solutions": ["Check Render service logs", "Verify backend health endpoint", "Check CORS settings"]
      },
      "database_connection_timeout": {
        "symptoms": "Backend fails to start, database errors in logs",
        "causes": ["Supabase connection string incorrect", "Database overloaded", "Connection pool exhausted"],
        "solutions": ["Verify DATABASE_URL environment variable", "Check Supabase dashboard", "Increase connection pool size"]
      },
      "build_failures": {
        "symptoms": "Render build fails, deployment stuck",
        "causes": ["Dependency conflicts", "Build command errors", "Out of memory"],
        "solutions": ["Check build logs in Render", "Update dependencies", "Increase build resources"]
      }
    },
    "monitoring_endpoints": {
      "backend_health": "GET /health",
      "backend_ready": "GET /health/ready",
      "backend_stats": "GET /api/stats",
      "database_status": "Check via backend logs"
    }
  },
  "security_considerations": {
    "environment_variables": [
      "Never commit secrets to Git",
      "Use Render environment variables for production",
      "Rotate Kalshi API keys regularly",
      "Monitor for credential leaks"
    ],
    "database_security": [
      "Enable Row Level Security in Supabase",
      "Use least-privilege database user",
      "Regular security updates",
      "Monitor database access logs"
    ],
    "ssl_tls": [
      "Render provides automatic SSL",
      "Verify HTTPS redirect configuration",
      "Use secure headers",
      "Regular certificate renewal (automatic)"
    ]
  },
  "backup_and_recovery": {
    "database_backup": {
      "automated": "Supabase provides automatic backups",
      "manual": "supabase db dump --file backup-$(date +%Y%m%d).sql",
      "frequency": "Daily automated, weekly manual verification",
      "retention": "30 days automated, 90 days manual"
    },
    "application_backup": {
      "code": "Git repository serves as backup",
      "configuration": "Render service configuration in render.yaml",
      "environment": "Document all environment variables securely"
    },
    "disaster_recovery": {
      "rto": "Recovery Time Objective: 15 minutes",
      "rpo": "Recovery Point Objective: 1 hour",
      "procedures": [
        "Restore from Render service rollback",
        "Restore database from Supabase backup",
        "Verify all systems operational",
        "Update DNS if needed"
      ]
    }
  },
  "performance_optimization": {
    "render_optimizations": [
      "Use appropriate service tiers for traffic",
      "Configure auto-scaling rules",
      "Monitor resource usage",
      "Optimize build times"
    ],
    "supabase_optimizations": [
      "Use connection pooling for production",
      "Optimize database queries and indexes",
      "Monitor connection counts",
      "Consider read replicas for high traffic"
    ],
    "application_optimizations": [
      "Implement caching where appropriate",
      "Optimize WebSocket message frequency",
      "Use compression for large responses",
      "Monitor application performance metrics"
    ]
  },
  "success_criteria": {
    "technical": [
      "✅ WebSocket connections work reliably in production",
      "✅ Database performance meets or exceeds SQLite performance", 
      "✅ Deployment time reduced with warm restart functionality",
      "✅ Zero downtime deployments with health checks",
      "✅ All E2E regression tests pass in production"
    ],
    "operational": [
      "✅ Production monitoring and alerting operational",
      "✅ Backup and recovery procedures tested",
      "✅ Documentation complete and accessible",
      "✅ Team trained on deployment procedures",
      "✅ Cost optimization targets met"
    ],
    "business": [
      "✅ Application accessible to users 24/7",
      "✅ Real-time data flowing without interruption",
      "✅ Professional, reliable user experience",
      "✅ Scalable infrastructure for growth",
      "✅ Maintainable deployment process"
    ]
  },
  "next_steps_after_deployment": [
    "Monitor production performance and optimize as needed",
    "Implement additional monitoring and alerting",
    "Set up automated testing pipeline",
    "Plan for scaling and performance optimization",
    "Consider advanced features like CDN, caching, etc."
  ]
}